<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RedNote</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background: #f8f8f8; color: #111; line-height: 1.5; padding: 10px; max-width: 600px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    header h1 { font-size: 24px; color: #e02020; }
    .user-info { display: flex; align-items: center; gap: 8px; }
    .user-info img { width: 28px; height: 28px; border-radius: 50%; }
    .settings-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: #888; padding: 4px 8px; border-radius: 6px; }
    .settings-btn:hover { background: #f0f0f0; color: #333; }
    .create-post { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; resize: vertical; min-height: 60px; }
    button { background: #e02020; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:hover { background: #c01515; }
    .media-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .media-btn { background: #eee; color: #333; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .media-btn:hover { background: #ddd; }
    .photo-preview-container { position: relative; margin: 10px 0; border-radius: 8px; overflow: hidden; }
    .photo-preview-container img { width: 100%; max-height: 300px; object-fit: cover; display: block; }
    .photo-remove-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; }
    .video-hint { margin-top: 8px; font-size: 14px; color: #666; padding: 8px; background: #f9f9f9; border-radius: 6px; }
    .post { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .post-avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .post-author { font-weight: bold; }
    .post-time { color: #888; font-size: 13px; margin-left: 8px; }
    .post-content { margin: 10px 0; white-space: pre-wrap; }
    .post-media { margin: 10px 0; }
    .post-media img, .post-media video { max-width: 100%; border-radius: 8px; margin-top: 8px; }
    .post-actions { display: flex; gap: 16px; margin-top: 10px; }
    .like-btn, .comment-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .like-btn.liked { color: #e02020; }
    #profileModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; }
    .modal-content h2 { margin-bottom: 16px; color: #e02020; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 16px 0; }
    .avatar-option { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
    .avatar-option.selected { border-color: #e02020; }
    .avatar-option img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .loading { text-align: center; padding: 20px; color: #666; }
    .upload-progress { margin-top: 10px; display: none; }
    .progress-bar { background: #eee; height: 4px; border-radius: 2px; overflow: hidden; }
    .progress-fill { background: #e02020; height: 100%; width: 0%; transition: width 0.3s; }
    .progress-text { font-size: 12px; color: #666; margin-top: 4px; }
  </style>
</head>
<body>

  <div id="profileModal" style="display: none;">
    <div class="modal-content">
      <h2 id="modalTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!</h2>
      <p id="modalSubtitle">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá</p>
      <input type="text" id="userNameInput" placeholder="–í–∞—à–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫" maxlength="16">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</p>
      <div class="avatar-grid" id="avatarGrid"></div>
      <button id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <header>
    <h1>üî¥ RedNote</h1>
    <div class="user-info">
      <span id="userStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      <button class="settings-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <section class="create-post">
      <textarea id="postInput" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
      <div class="media-buttons">
        <label class="media-btn">üì∑ <input type="file" id="photoInput" accept="image/*" style="display:none"></label>
        <label class="media-btn">üé¨ <input type="file" id="videoInput" accept="video/*" style="display:none"></label>
      </div>
      <div id="photoPreviewContainer" style="display:none;" class="photo-preview-container">
        <img id="photoPreview" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
        <button class="photo-remove-btn" id="removePhotoBtn">√ó</button>
      </div>
      <div id="videoHint" style="display:none;" class="video-hint">üé¨ –í–∏–¥–µ–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.</div>
      <div id="uploadProgress" class="upload-progress">
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        <p id="progressText" class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞: 0%</p>
      </div>
      <button id="postButton">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </section>

    <section id="feed"><p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p></section>
  </main>

  <script>
    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø SUPABASE ====================
    const SUPABASE_URL = 'https://oenxpnkoqwpzh1rewcqc.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_B_9Ydvs28XP_sxQaZuhRoQ_FeFUeEPX'; // –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ö–õ–Æ–ß!
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
    let photoFile = null;
    let videoFile = null;
    
    // –ê–≤–∞—Ç–∞—Ä—ã
    const avatars = [
      "https://api.dicebear.com/7.x/bottts/svg?seed=1",
      "https://api.dicebear.com/7.x/bottts/svg?seed=2",
      "https://api.dicebear.com/7.x/bottts/svg?seed=3",
      "https://api.dicebear.com/7.x/bottts/svg?seed=4",
      "https://api.dicebear.com/7.x/bottts/svg?seed=5",
      "https://api.dicebear.com/7.x/bottts/svg?seed=6",
      "https://api.dicebear.com/7.x/bottts/svg?seed=7",
      "https://api.dicebear.com/7.x/bottts/svg?seed=8"
    ];
    
    // ==================== –§–£–ù–ö–¶–ò–ò –ü–†–û–§–ò–õ–Ø ====================
    function getProfile() {
      const data = localStorage.getItem('userProfile');
      return data ? JSON.parse(data) : null;
    }
    
    function saveProfile(name, avatarUrl) {
      const profile = { name, avatarUrl, timestamp: Date.now() };
      localStorage.setItem('userProfile', JSON.stringify(profile));
      return profile;
    }
    
    function updateUI(profile) {
      document.getElementById('userStatus').innerHTML = 
        `<img src="${profile.avatarUrl}" width="28" height="28" style="border-radius:50%;"> <span>${profile.name}</span>`;
    }
    
    // ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ====================
    function openProfileModal(isEditing = false) {
      const modal = document.getElementById('profileModal');
      const title = document.getElementById('modalTitle');
      const subtitle = document.getElementById('modalSubtitle');
      const nameInput = document.getElementById('userNameInput');
      const saveBtn = document.getElementById('saveProfileBtn');
      const grid = document.getElementById('avatarGrid');
      
      title.textContent = isEditing ? '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è' : '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!';
      subtitle.textContent = isEditing ? '–ò–∑–º–µ–Ω–∏—Ç–µ –∏–º—è –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä' : '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá';
      
      const profile = getProfile() || { name: '', avatarUrl: avatars[0] };
      nameInput.value = profile.name;
      
      grid.innerHTML = avatars.map((url, i) => 
        `<div class="avatar-option ${url === profile.avatarUrl ? 'selected' : ''}" data-url="${url}">
          <img src="${url}" alt="–ê–≤–∞—Ç–∞—Ä ${i+1}">
        </div>`
      ).join('');
      
      grid.querySelectorAll('.avatar-option').forEach(el => {
        el.onclick = () => {
          grid.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
          el.classList.add('selected');
        };
      });
      
      saveBtn.onclick = () => {
        const name = nameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';
        const selected = grid.querySelector('.avatar-option.selected');
        const avatarUrl = selected ? selected.dataset.url : avatars[0];
        const newProfile = saveProfile(name, avatarUrl);
        updateUI(newProfile);
        modal.style.display = 'none';
        
        if (!isEditing) {
          loadPosts();
        }
      };
      
      modal.style.display = 'flex';
    }
    
    // ==================== –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–û–í ====================
    async function uploadFile(file) {
      if (!file) return null;
      
      try {
        document.getElementById('uploadProgress').style.display = 'block';
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressText').textContent = '–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...';
        
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
        const filePath = `posts/${fileName}`;
        
        const { error } = await supabase.storage
          .from('media')
          .upload(filePath, file);
        
        if (error) throw error;
        
        const { data: urlData } = supabase.storage
          .from('media')
          .getPublicUrl(filePath);
        
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressText').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
        
        setTimeout(() => {
          document.getElementById('uploadProgress').style.display = 'none';
        }, 1000);
        
        return urlData.publicUrl;
        
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
        document.getElementById('uploadProgress').style.display = 'none';
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: " + err.message);
        return null;
      }
    }
    
    // ==================== –ü–û–°–¢–´ ====================
    async function addPost() {
      const text = document.getElementById('postInput').value.trim();
      if (!text && !photoFile && !videoFile) {
        alert('–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ');
        return;
      }
      
      const profile = getProfile() || { name: '–ê–Ω–æ–Ω–∏–º', avatarUrl: avatars[0] };
      let photoUrl = null, videoUrl = null;
      
      try {
        if (photoFile) photoUrl = await uploadFile(photoFile);
        if (videoFile) videoUrl = await uploadFile(videoFile);
        
        const { error } = await supabase
          .from('posts')
          .insert([{
            text: text,
            user_name: profile.name,
            user_avatar: profile.avatarUrl,
            photo_url: photoUrl,
            video_url: videoUrl,
            likes: 0,
            liked_by: [],
            created_at: new Date().toISOString()
          }]);
        
        if (error) throw error;
        
        photoFile = null;
        videoFile = null;
        document.getElementById('photoInput').value = '';
        document.getElementById('videoInput').value = '';
        document.getElementById('photoPreviewContainer').style.display = 'none';
        document.getElementById('videoHint').style.display = 'none';
        document.getElementById('postInput').value = '';
        document.getElementById('uploadProgress').style.display = 'none';
        
        await loadPosts();
        
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:", err);
        alert("–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: " + err.message);
      }
    }
    
    async function loadPosts() {
      try {
        const { data: posts, error } = await supabase
          .from('posts')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        renderPosts(posts || []);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:", err);
        document.getElementById('feed').innerHTML = '<p class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</p>';
      }
    }
    
    function renderPosts(posts) {
      const feed = document.getElementById('feed');
      
      if (!posts || posts.length === 0) {
        feed.innerHTML = '<p class="loading">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
        return;
      }
      
      feed.innerHTML = posts.map(post => {
        const time = new Date(post.created_at).toLocaleString('ru-RU', {
          day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
        });
        
        const profile = getProfile();
        const liked = post.liked_by?.includes(profile?.name);
        
        let mediaHtml = '';
        if (post.photo_url) {
          mediaHtml += `<img src="${post.photo_url}" alt="–§–æ—Ç–æ" style="max-width:100%; border-radius:8px;">`;
        }
        if (post.video_url) {
          mediaHtml += `<video controls style="max-width:100%; border-radius:8px;"><source src="${post.video_url}" type="video/mp4"></video>`;
        }
        
        return `
          <article class="post">
            <div class="post-header">
              <img src="${post.user_avatar || avatars[0]}" class="post-avatar" alt="–ê–≤–∞—Ç–∞—Ä">
              <span class="post-author">${post.user_name || '–ê–Ω–æ–Ω–∏–º'}</span>
              <span class="post-time">${time}</span>
            </div>
            ${post.text ? `<div class="post-content">${post.text.replace(/\n/g, '<br>')}</div>` : ''}
            ${mediaHtml ? `<div class="post-media">${mediaHtml}</div>` : ''}
            <div class="post-actions">
              <button class="like-btn ${liked ? 'liked' : ''}" onclick="window.toggleLike(${JSON.stringify(post).replace(/"/g, '&quot;')})">
                ‚ù§Ô∏è ${post.likes || 0}
              </button>
              <button class="comment-btn">üí¨ 0</button>
            </div>
          </article>
        `;
      }).join('');
    }
    
    async function toggleLike(post) {
      const profile = getProfile() || { name: 'temp' };
      const isLiked = post.liked_by?.includes(profile.name);
      
      try {
        const { error } = await supabase
          .from('posts')
          .update({
            likes: isLiked ? post.likes - 1 : post.likes + 1,
            liked_by: isLiked 
              ? post.liked_by.filter(name => name !== profile.name)
              : [...(post.liked_by || []), profile.name]
          })
          .eq('id', post.id);
        
        if (error) throw error;
        
        await loadPosts();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ª–∞–π–∫–∞:", err);
      }
    }
    
    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    document.addEventListener('DOMContentLoaded', () => {
      const photoInput = document.getElementById('photoInput');
      const videoInput = document.getElementById('videoInput');
      const photoPreview = document.getElementById('photoPreview');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const removePhotoBtn = document.getElementById('removePhotoBtn');
      const videoHint = document.getElementById('videoHint');
      const postInput = document.getElementById('postInput');
      const postButton = document.getElementById('postButton');
      const settingsBtn = document.getElementById('settingsBtn');
      
      photoInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          if (file.size > 5 * 1024 * 1024) {
            alert('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
            photoInput.value = '';
            return;
          }
          
          photoFile = file;
          const reader = new FileReader();
          reader.onload = (event) => {
            photoPreview.src = event.target.result;
            photoPreviewContainer.style.display = 'block';
            videoHint.style.display = 'none';
          };
          reader.readAsDataURL(file);
        } else {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          photoInput.value = '';
        }
      };
      
      videoInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('video/')) {
          if (file.size > 50 * 1024 * 1024) {
            alert('–í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50MB');
            videoInput.value = '';
            return;
          }
          
          videoFile = file;
          videoHint.style.display = 'block';
          photoPreviewContainer.style.display = 'none';
        } else {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ');
          videoInput.value = '';
        }
      };
      
      removePhotoBtn.onclick = () => {
        photoFile = null;
        photoInput.value = '';
        photoPreviewContainer.style.display = 'none';
      };
      
      postButton.onclick = addPost;
      
      postInput.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          addPost();
        }
      };
      
      settingsBtn.onclick = () => openProfileModal(true);
      
      window.toggleLike = toggleLike;
      
      const profile = getProfile();
      if (!profile) {
        openProfileModal(false);
      } else {
        updateUI(profile);
        loadPosts();
      }
    });
  </script>
</body>
</html>
