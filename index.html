
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RedNote</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background: #f8f8f8; color: #111; line-height: 1.5; padding: 10px; max-width: 600px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    header h1 { font-size: 24px; color: #e02020; }
    .user-info { display: flex; align-items: center; gap: 8px; }
    .user-info img { width: 28px; height: 28px; border-radius: 50%; }
    .settings-btn {
      background: none; border: none; font-size: 20px; cursor: pointer;
      color: #888; padding: 4px 8px; border-radius: 6px;
    }
    .settings-btn:hover { background: #f0f0f0; color: #333; }
    .create-post { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; resize: vertical; min-height: 60px; }
    button { background: #e02020; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:hover { background: #c01515; }
    .post { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .post-avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .post-author { font-weight: bold; }
    .post-time { color: #888; font-size: 13px; margin-left: 8px; }
    .post-content { margin: 10px 0; white-space: pre-wrap; }
    .post-actions { display: flex; gap: 16px; margin-top: 10px; }
    .like-btn, .comment-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .like-btn.liked { color: #e02020; }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è */
    #profileModal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .modal-content h2 { margin-bottom: 16px; color: #e02020; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 16px 0;
    }
    .avatar-option {
      width: 50px; height: 50px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .avatar-option.selected { border-color: #e02020; }
    .avatar-option img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
  </style>
</head>
<body>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
  <div id="profileModal" style="display: none;">
    <div class="modal-content">
      <h2 id="modalTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!</h2>
      <p id="modalSubtitle">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá</p>
      <input type="text" id="userNameInput" placeholder="–í–∞—à–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫" maxlength="16">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</p>
      <div class="avatar-grid" id="avatarGrid">
        <!-- –ê–≤–∞—Ç–∞—Ä–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã JS -->
      </div>
      <button id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <header>
    <h1>üî¥ RedNote</h1>
    <div class="user-info">
      <span id="userStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      <button class="settings-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <section class="create-post">
      <textarea id="postInput" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
      <button id="postButton">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </section>

    <section id="feed">
      <p id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // üîë –í–∞—à –∫–æ–Ω—Ñ–∏–≥ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA4s_CNAGnOZ5SRjVrdmV1YwX2ZdCPS0NM",
      authDomain: "rednote-ff51d.firebaseapp.com",
      projectId: "rednote-ff51d",
      storageBucket: "rednote-ff51d.firebasestorage.app",
      messagingSenderId: "816401681398",
      appId: "1:816401681398:web:0540d6b83ca2d0ebd115d7",
      measurementId: "G-VFQLG7YF77"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const avatars = [
      "https://api.dicebear.com/7.x/bottts/svg?seed=1",
      "https://api.dicebear.com/7.x/bottts/svg?seed=2",
      "https://api.dicebear.com/7.x/bottts/svg?seed=3",
      "https://api.dicebear.com/7.x/bottts/svg?seed=4",
      "https://api.dicebear.com/7.x/bottts/svg?seed=5",
      "https://api.dicebear.com/7.x/bottts/svg?seed=6",
      "https://api.dicebear.com/7.x/bottts/svg?seed=7",
      "https://api.dicebear.com/7.x/bottts/svg?seed=8"
    ];

    function getProfile() {
      const data = localStorage.getItem('userProfile');
      return data ? JSON.parse(data) : null;
    }

    function saveProfile(name, avatarUrl) {
      const profile = { name, avatarUrl, timestamp: Date.now() };
      localStorage.setItem('userProfile', JSON.stringify(profile));
      return profile;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ –ò–õ–ò —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    function openProfileModal(isEditing = false) {
      const modal = document.getElementById('profileModal');
      const title = document.getElementById('modalTitle');
      const subtitle = document.getElementById('modalSubtitle');
      const nameInput = document.getElementById('userNameInput');
      const saveBtn = document.getElementById('saveProfileBtn');
      const grid = document.getElementById('avatarGrid');

      if (isEditing) {
        title.textContent = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è';
        subtitle.textContent = '–ò–∑–º–µ–Ω–∏—Ç–µ –∏–º—è –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä';
      } else {
        title.textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!';
        subtitle.textContent = '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá';
      }

      const profile = getProfile() || { name: '', avatarUrl: avatars[0] };

      nameInput.value = profile.name;
      grid.innerHTML = avatars.map((url, i) => 
        `<div class="avatar-option ${url === profile.avatarUrl ? 'selected' : ''}" data-url="${url}">
          <img src="${url}" alt="–ê–≤–∞—Ç–∞—Ä ${i+1}">
        </div>`
      ).join('');

      grid.querySelectorAll('.avatar-option').forEach(el => {
        el.onclick = () => {
          grid.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
          el.classList.add('selected');
        };
      });

      saveBtn.onclick = () => {
        const name = nameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';
        const selected = grid.querySelector('.avatar-option.selected');
        const avatarUrl = selected ? selected.dataset.url : avatars[0];

        const newProfile = saveProfile(name, avatarUrl);
        updateUI(newProfile);

        modal.style.display = 'none';
      };

      modal.style.display = 'flex';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
    function updateUI(profile) {
      const userStatus = document.getElementById('userStatus');
      userStatus.innerHTML = `<img src="${profile.avatarUrl}" width="28" height="28" style="border-radius:50%;"> <span>${profile.name}</span>`;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function initApp() {
      const profile = getProfile();
      const userStatus = document.getElementById('userStatus');

      if (!profile) {
        openProfileModal(false);
      } else {
        updateUI(profile);
      }

      // --- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
      document.getElementById('settingsBtn').onclick = () => {
        openProfileModal(true); // true = —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      };

      // --- –†–∞–±–æ—Ç–∞ —Å –ø–æ—Å—Ç–∞–º–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
      async function addPost(text) {
        const p = getProfile() || { name: '–ê–Ω–æ–Ω–∏–º', avatarUrl: avatars[0] };
        await db.collection('posts').add({
          text,
          userId: p.name,
          userAvatar: p.avatarUrl,
          likes: 0,
          likedBy: [],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      async function toggleLike(postId, liked) {
        const p = getProfile() || { name: 'temp' };
        const postRef = db.collection('posts').doc(postId);
        if (liked) {
          await postRef.update({
            likes: firebase.firestore.FieldValue.increment(1),
            likedBy: firebase.firestore.FieldValue.arrayUnion(p.name)
          });
        } else {
          await postRef.update({
            likes: firebase.firestore.FieldValue.increment(-1),
            likedBy: firebase.firestore.FieldValue.arrayRemove(p.name)
          });
        }
      }

      function renderPosts() {
        const feed = document.getElementById('feed');
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        db.collection('posts')
          .orderBy('timestamp', 'desc')
          .onSnapshot(snapshot => {
            loading.style.display = 'none';
            const posts = [];
            snapshot.forEach(doc => {
              posts.push({ id: doc.id, ...doc.data() });
            });

            feed.innerHTML = posts.map(p => {
              const time = new Date(p.timestamp?.toDate?.() || p.timestamp).toLocaleString('ru-RU', {
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
              });

              const prof = getProfile();
              const liked = p.likedBy?.includes(prof?.name);
              const avatar = p.userAvatar || avatars[0];
              const author = p.userId || '–ì–æ—Å—Ç—å';

              return `
                <article class="post">
                  <div class="post-header">
                    <img src="${avatar}" class="post-avatar" alt="">
                    <span class="post-author">${author}</span>
                    <span class="post-time">${time}</span>
                  </div>
                  <div class="post-content">${(p.text || '').replace(/\n/g, '<br>')}</div>
                  <div class="post-actions">
                    <button class="like-btn ${liked ? 'liked' : ''}" data-id="${p.id}">
                      ‚ù§Ô∏è ${p.likes || 0}
                    </button>
                    <button class="comment-btn">üí¨ 0</button>
                  </div>
                </article>
              `;
            }).join('');

            document.querySelectorAll('.like-btn').forEach(btn => {
              btn.onclick = async () => {
                const id = btn.dataset.id;
                const liked = btn.classList.contains('liked');
                await toggleLike(id, !liked);
              };
            });
          });
      }

      document.getElementById('postButton').onclick = async () => {
        const input = document.getElementById('postInput');
        const text = input.value.trim();
        if (!text) return;
        await addPost(text);
        input.value = '';
      };

      document.getElementById('postInput').onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.getElementById('postButton').click();
        }
      };

      renderPosts();
    }

    initApp();
  </script>

</body>
</html>
