<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RedNote</title>
  <style>
    /* ... (–≤—Å–µ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ‚Äî –∫–æ–ø–∏—Ä—É–π—Ç–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å ... */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background: #f8f8f8; color: #111; line-height: 1.5; padding: 10px; max-width: 600px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    header h1 { font-size: 24px; color: #e02020; }
    .user-info { display: flex; align-items: center; gap: 8px; }
    .user-info img { width: 28px; height: 28px; border-radius: 50%; }
    .settings-btn {
      background: none; border: none; font-size: 20px; cursor: pointer;
      color: #888; padding: 4px 8px; border-radius: 6px;
    }
    .settings-btn:hover { background: #f0f0f0; color: #333; }
    .create-post { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; resize: vertical; min-height: 60px; }
    button { background: #e02020; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:hover { background: #c01515; }
    .media-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .media-btn {
      background: #eee; color: #333; padding: 6px 12px; border-radius: 6px; cursor: pointer;
      font-size: 14px; display: flex; align-items: center; gap: 4px;
    }
    .media-btn:hover { background: #ddd; }
    .photo-preview-container {
      position: relative;
      margin: 10px 0;
      border-radius: 8px;
      overflow: hidden;
    }
    .photo-preview-container img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      display: block;
    }
    .photo-remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
    }
    .video-hint {
      margin-top: 8px;
      font-size: 14px;
      color: #666;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    .post { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .post-avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .post-author { font-weight: bold; }
    .post-time { color: #888; font-size: 13px; margin-left: 8px; }
    .post-content { margin: 10px 0; white-space: pre-wrap; }
    .post-media { margin: 10px 0; }
    .post-media img, .post-media video {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 8px;
    }
    .post-actions { display: flex; gap: 16px; margin-top: 10px; }
    .like-btn, .comment-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .like-btn.liked { color: #e02020; }
    #profileModal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .modal-content h2 { margin-bottom: 16px; color: #e02020; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 16px 0;
    }
    .avatar-option {
      width: 50px; height: 50px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .avatar-option.selected { border-color: #e02020; }
    .avatar-option img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
  </style>
</head>
<body>

  <div id="profileModal" style="display: none;">
    <div class="modal-content">
      <h2 id="modalTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!</h2>
      <p id="modalSubtitle">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá</p>
      <input type="text" id="userNameInput" placeholder="–í–∞—à–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫" maxlength="16">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</p>
      <div class="avatar-grid" id="avatarGrid"></div>
      <button id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <header>
    <h1>üî¥ RedNote</h1>
    <div class="user-info">
      <span id="userStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      <button class="settings-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <section class="create-post">
      <textarea id="postInput" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
      <div class="media-buttons">
        <label class="media-btn">
          üì∑ <input type="file" id="photoInput" accept="image/*" style="display:none">
        </label>
        <label class="media-btn">
          üé¨ <input type="file" id="videoInput" accept="video/*" style="display:none">
        </label>
      </div>
      <div id="photoPreviewContainer" style="display:none;" class="photo-preview-container">
        <img id="photoPreview" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
        <button class="photo-remove-btn" id="removePhotoBtn">√ó</button>
      </div>
      <div id="videoHint" style="display:none;" class="video-hint">
        üé¨ –í–∏–¥–µ–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
      </div>
      <button id="postButton">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </section>

    <section id="feed">
      <p id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    // üîë –í–∞—à –∫–æ–Ω—Ñ–∏–≥ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA4s_CNAGnOZ5SRjVrdmV1YwX2ZdCPS0NM",
      authDomain: "rednote-ff51d.firebaseapp.com",
      projectId: "rednote-ff51d",
      storageBucket: "rednote-ff51d.firebasestorage.app",
      messagingSenderId: "816401681398",
      appId: "1:816401681398:web:0540d6b83ca2d0ebd115d7",
      measurementId: "G-VFQLG7YF77"
    };

    // üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', async () => {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const storage = firebase.storage();

      const avatars = [
        "https://api.dicebear.com/7.x/bottts/svg?seed=1",
        "https://api.dicebear.com/7.x/bottts/svg?seed=2",
        "https://api.dicebear.com/7.x/bottts/svg?seed=3",
        "https://api.dicebear.com/7.x/bottts/svg?seed=4",
        "https://api.dicebear.com/7.x/bottts/svg?seed=5",
        "https://api.dicebear.com/7.x/bottts/svg?seed=6",
        "https://api.dicebear.com/7.x/bottts/svg?seed=7",
        "https://api.dicebear.com/7.x/bottts/svg?seed=8"
      ];

      // üì¶ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî —Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ DOMContentLoaded
      let photoFile = null;
      let videoFile = null;

      // üì¶ –†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      function getProfile() {
        const data = localStorage.getItem('userProfile');
        return data ? JSON.parse(data) : null;
      }
      function saveProfile(name, avatarUrl) {
        const profile = { name, avatarUrl, timestamp: Date.now() };
        localStorage.setItem('userProfile', JSON.stringify(profile));
        return profile;
      }

      // üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
      async function uploadFile(file) {
        if (!file) return null;
        const storageRef = storage.ref(`posts/${Date.now()}_${file.name}`);
        const snapshot = await storageRef.put(file);
        return await snapshot.ref.getDownloadURL();
      }

      // üñº –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      function openProfileModal(isEditing = false) {
        const modal = document.getElementById('profileModal');
        const title = document.getElementById('modalTitle');
        const subtitle = document.getElementById('modalSubtitle');
        const nameInput = document.getElementById('userNameInput');
        const saveBtn = document.getElementById('saveProfileBtn');
        const grid = document.getElementById('avatarGrid');

        if (isEditing) {
          title.textContent = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è';
          subtitle.textContent = '–ò–∑–º–µ–Ω–∏—Ç–µ –∏–º—è –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä';
        } else {
          title.textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!';
          subtitle.textContent = '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá';
        }

        const profile = getProfile() || { name: '', avatarUrl: avatars[0] };
        nameInput.value = profile.name;

        grid.innerHTML = avatars.map((url, i) => 
          `<div class="avatar-option ${url === profile.avatarUrl ? 'selected' : ''}" data-url="${url}">
            <img src="${url}" alt="–ê–≤–∞—Ç–∞—Ä ${i+1}">
          </div>`
        ).join('');

        grid.querySelectorAll('.avatar-option').forEach(el => {
          el.onclick = () => {
            grid.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
          };
        });

        saveBtn.onclick = () => {
          const name = nameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';
          const selected = grid.querySelector('.avatar-option.selected');
          const avatarUrl = selected ? selected.dataset.url : avatars[0];
          const newProfile = saveProfile(name, avatarUrl);
          updateUI(newProfile);
          modal.style.display = 'none';
        };

        modal.style.display = 'flex';
      }

      function updateUI(profile) {
        document.getElementById('userStatus').innerHTML = 
          `<img src="${profile.avatarUrl}" width="28" height="28" style="border-radius:50%;"> <span>${profile.name}</span>`;
      }

      // ‚úÖ –ì–ª–∞–≤–Ω–æ–µ: –ø—Ä–∏–≤—è–∑–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      const photoInput = document.getElementById('photoInput');
      const videoInput = document.getElementById('videoInput');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const photoPreview = document.getElementById('photoPreview');
      const removePhotoBtn = document.getElementById('removePhotoBtn');
      const videoHint = document.getElementById('videoHint');
      const postInput = document.getElementById('postInput');
      const postButton = document.getElementById('postButton');

      // üì∑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ
      photoInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          photoFile = file;
          const reader = new FileReader();
          reader.onload = (event) => {
            photoPreview.src = event.target.result;
            photoPreviewContainer.style.display = 'block';
            videoHint.style.display = 'none';
          };
          reader.readAsDataURL(file);
        } else {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          photoInput.value = '';
        }
      };

      videoInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('video/')) {
          videoFile = file;
          videoHint.style.display = 'block';
          photoPreviewContainer.style.display = 'none';
        } else {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥–µ–æ');
          videoInput.value = '';
        }
      };

      removePhotoBtn.onclick = () => {
        photoFile = null;
        photoInput.value = '';
        photoPreviewContainer.style.display = 'none';
      };

      // ‚úâÔ∏è –ü—É–±–ª–∏–∫–∞—Ü–∏—è
      async function addPost() {
        const text = postInput.value.trim();
        if (!text && !photoFile && !videoFile) {
          alert('–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ');
          return;
        }

        const p = getProfile() || { name: '–ê–Ω–æ–Ω–∏–º', avatarUrl: avatars[0] };
        let photoUrl = null, videoUrl = null;

        try {
          if (photoFile) {
            console.log("üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...");
            photoUrl = await uploadFile(photoFile);
            console.log("‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ");
          }
          if (videoFile) {
            console.log("üé¨ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ...");
            videoUrl = await uploadFile(videoFile);
            console.log("‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ");
          }

          await db.collection('posts').add({
            text,
            userId: p.name,
            userAvatar: p.avatarUrl,
            media: { photo: photoUrl, video: videoUrl },
            likes: 0,
            likedBy: [],
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          // üßπ –û—á–∏—Å—Ç–∫–∞
          photoFile = null;
          videoFile = null;
          photoInput.value = '';
          videoInput.value = '';
          photoPreviewContainer.style.display = 'none';
          videoHint.style.display = 'none';
          postInput.value = '';

          console.log("‚úÖ –ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω");
        } catch (err) {
          console.error("‚ùå –û—à–∏–±–∫–∞:", err);
          alert("–û—à–∏–±–∫–∞: " + (err.message || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"));
        }
      }

      // ‚ù§Ô∏è –õ–∞–π–∫–∏ –∏ —Ä–µ–Ω–¥–µ—Ä (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      async function toggleLike(postId, liked) {
        const p = getProfile() || { name: 'temp' };
        const postRef = db.collection('posts').doc(postId);
        await postRef.update({
          likes: firebase.firestore.FieldValue.increment(liked ? 1 : -1),
          likedBy: liked 
            ? firebase.firestore.FieldValue.arrayUnion(p.name)
            : firebase.firestore.FieldValue.arrayRemove(p.name)
        });
      }

      function renderPosts() {
        const feed = document.getElementById('feed');
        feed.innerHTML = '<p id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>';

        db.collection('posts')
          .orderBy('timestamp', 'desc')
          .onSnapshot(snapshot => {
            document.getElementById('loading').style.display = 'none';
            const posts = [];
            snapshot.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));

            feed.innerHTML = posts.map(p => {
              const time = new Date(p.timestamp?.toDate?.() || p.timestamp).toLocaleString('ru-RU', {
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
              });

              const prof = getProfile();
              const liked = p.likedBy?.includes(prof?.name);
              const avatar = p.userAvatar || avatars[0];
              const author = p.userId || '–ì–æ—Å—Ç—å';

              let mediaHtml = '';
              if (p.media?.photo) mediaHtml += `<img src="${p.media.photo}" alt="–§–æ—Ç–æ">`;
              if (p.media?.video) mediaHtml += `<video controls><source src="${p.media.video}" type="video/mp4"></video>`;

              return `
                <article class="post">
                  <div class="post-header">
                    <img src="${avatar}" class="post-avatar" alt="">
                    <span class="post-author">${author}</span>
                    <span class="post-time">${time}</span>
                  </div>
                  <div class="post-content">${(p.text || '').replace(/\n/g, '<br>')}</div>
                  ${mediaHtml ? `<div class="post-media">${mediaHtml}</div>` : ''}
                  <div class="post-actions">
                    <button class="like-btn ${liked ? 'liked' : ''}" data-id="${p.id}">
                      ‚ù§Ô∏è ${p.likes || 0}
                    </button>
                    <button class="comment-btn">üí¨ 0</button>
                  </div>
                </article>
              `;
            }).join('');

            document.querySelectorAll('.like-btn').forEach(btn => {
              btn.onclick = async () => {
                const id = btn.dataset.id;
                const liked = btn.classList.contains('liked');
                await toggleLike(id, !liked);
              };
            });
          });
      }

      // üîó –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
      postButton.onclick = addPost;
      postInput.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          addPost();
        }
      };
      document.getElementById('settingsBtn').onclick = () => openProfileModal(true);

      // üèÅ –ó–∞–ø—É—Å–∫
      const profile = getProfile();
      if (!profile) {
        openProfileModal(false);
      } else {
        updateUI(profile);
        renderPosts();
      }
    });
  </script>

</body>
</html>
