<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RedNote</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background: #f8f8f8; color: #111; line-height: 1.5; padding: 10px; max-width: 600px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    header h1 { font-size: 24px; color: #e02020; }
    .create-post { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; resize: vertical; min-height: 60px; }
    button { background: #e02020; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:hover { background: #c01515; }
    .post { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .post-avatar { width: 32px; height: 32px; border-radius: 50%; background: #eee; margin-right: 10px; }
    .post-author { font-weight: bold; }
    .post-time { color: #888; font-size: 13px; margin-left: 8px; }
    .post-content { margin: 10px 0; white-space: pre-wrap; }
    .post-actions { display: flex; gap: 16px; margin-top: 10px; }
    .like-btn, .comment-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .like-btn.liked { color: #e02020; }
  </style>
</head>
<body>

  <header>
    <h1>üî¥ RedNote</h1>
    <div id="userStatus">–ì–æ—Å—Ç—å</div>
  </header>

  <main>
    <section class="create-post">
      <textarea id="postInput" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
      <button id="postButton">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </section>

    <section id="feed">
      <p id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // üîë –í–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ Firebase (—É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω!)
    const firebaseConfig = {
      apiKey: "AIzaSyA4s_CNAGnOZ5SRjVrdmV1YwX2ZdCPS0NM",
      authDomain: "rednote-ff51d.firebaseapp.com",
      projectId: "rednote-ff51d",
      storageBucket: "rednote-ff51d.firebasestorage.app",
      messagingSenderId: "816401681398",
      appId: "1:816401681398:web:0540d6b83ca2d0ebd115d7",
      measurementId: "G-VFQLG7YF77"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º "—Ö—ç—à —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
    function getDeviceId() {
      let id = localStorage.getItem('deviceId');
      if (!id) {
        id = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', id);
      }
      return id;
    }

    const userId = getDeviceId();
    document.getElementById('userStatus').textContent = userId;

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
    async function addPost(text) {
      await db.collection('posts').add({
        text,
        userId,
        likes: 0,
        likedBy: [],
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    // –õ–∞–π–∫ –ø–æ—Å—Ç–∞
    async function toggleLike(postId, liked) {
      const postRef = db.collection('posts').doc(postId);
      if (liked) {
        await postRef.update({
          likes: firebase.firestore.FieldValue.increment(1),
          likedBy: firebase.firestore.FieldValue.arrayUnion(userId)
        });
      } else {
        await postRef.update({
          likes: firebase.firestore.FieldValue.increment(-1),
          likedBy: firebase.firestore.FieldValue.arrayRemove(userId)
        });
      }
    }

    // –ß—Ç–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    function renderPosts() {
      const feed = document.getElementById('feed');
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      db.collection('posts')
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          loading.style.display = 'none';
          const posts = [];
          snapshot.forEach(doc => {
            posts.push({ id: doc.id, ...doc.data() });
          });

          feed.innerHTML = posts.map(p => {
            const time = new Date(p.timestamp?.toDate?.() || p.timestamp).toLocaleString('ru-RU', {
              day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
            });

            const liked = p.likedBy?.includes(userId);
            return `
              <article class="post">
                <div class="post-header">
                  <div class="post-avatar"></div>
                  <span class="post-author">${p.userId || '–ì–æ—Å—Ç—å'}</span>
                  <span class="post-time">${time}</span>
                </div>
                <div class="post-content">${(p.text || '').replace(/\n/g, '<br>')}</div>
                <div class="post-actions">
                  <button class="like-btn ${liked ? 'liked' : ''}" data-id="${p.id}">
                    ‚ù§Ô∏è ${p.likes || 0}
                  </button>
                  <button class="comment-btn">üí¨ 0</button>
                </div>
              </article>
            `;
          }).join('');

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ª–∞–π–∫–æ–≤
          document.querySelectorAll('.like-btn').forEach(btn => {
            btn.onclick = async () => {
              const id = btn.dataset.id;
              const liked = btn.classList.contains('liked');
              await toggleLike(id, !liked);
            };
          });
        });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞
    document.getElementById('postButton').onclick = async () => {
      const input = document.getElementById('postInput');
      const text = input.value.trim();
      if (!text) return;
      await addPost(text);
      input.value = '';
    };

    // Enter ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
    document.getElementById('postInput').onkeydown = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('postButton').click();
      }
    };

    // –ó–∞–ø—É—Å–∫
    renderPosts();
  </script>

</body>
</html>
