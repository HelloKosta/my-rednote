<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RedNote</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body { background: #f8f8f8; color: #111; line-height: 1.5; padding: 10px; max-width: 600px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    header h1 { font-size: 24px; color: #e02020; }
    .user-info { display: flex; align-items: center; gap: 8px; }
    .user-info img { width: 28px; height: 28px; border-radius: 50%; }
    .settings-btn {
      background: none; border: none; font-size: 20px; cursor: pointer;
      color: #888; padding: 4px 8px; border-radius: 6px;
    }
    .settings-btn:hover { background: #f0f0f0; color: #333; }
    .create-post { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; resize: vertical; min-height: 60px; }
    button { background: #e02020; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:hover { background: #c01515; }
    .media-buttons { display: flex; gap: 8px; margin-top: 8px; }
    .media-btn {
      background: #eee; color: #333; padding: 6px 12px; border-radius: 6px; cursor: pointer;
      font-size: 14px; display: flex; align-items: center; gap: 4px;
    }
    .media-btn:hover { background: #ddd; }
    
    /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ */
    .photo-preview-container {
      position: relative;
      margin: 10px 0;
      border-radius: 8px;
      overflow: hidden;
    }
    .photo-preview-container img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      display: block;
    }
    .photo-remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
    }
    .video-hint {
      margin-top: 8px;
      font-size: 14px;
      color: #666;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 6px;
    }

    .post { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .post-avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .post-author { font-weight: bold; }
    .post-time { color: #888; font-size: 13px; margin-left: 8px; }
    .post-content { margin: 10px 0; white-space: pre-wrap; }
    .post-media { margin: 10px 0; }
    .post-media img, .post-media video {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 8px;
    }
    .post-actions { display: flex; gap: 16px; margin-top: 10px; }
    .like-btn, .comment-btn { background: none; border: none; color: #555; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .like-btn.liked { color: #e02020; }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è */
    #profileModal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .modal-content h2 { margin-bottom: 16px; color: #e02020; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 16px 0;
    }
    .avatar-option {
      width: 50px; height: 50px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    .avatar-option.selected { border-color: #e02020; }
    .avatar-option img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
  </style>
</head>
<body>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
  <div id="profileModal" style="display: none;">
    <div class="modal-content">
      <h2 id="modalTitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!</h2>
      <p id="modalSubtitle">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá</p>
      <input type="text" id="userNameInput" placeholder="–í–∞—à–µ –∏–º—è –∏–ª–∏ –Ω–∏–∫" maxlength="16">
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä:</p>
      <div class="avatar-grid" id="avatarGrid">
        <!-- –ê–≤–∞—Ç–∞—Ä–∫–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã JS -->
      </div>
      <button id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <header>
    <h1>üî¥ RedNote</h1>
    <div class="user-info">
      <span id="userStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      <button class="settings-btn" id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <section class="create-post">
      <textarea id="postInput" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
      
      <div class="media-buttons">
        <label class="media-btn">
          üì∑ <input type="file" id="photoInput" accept="image/*" style="display:none">
        </label>
        <label class="media-btn">
          üé¨ <input type="file" id="videoInput" accept="video/*" style="display:none">
        </label>
      </div>

      <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ -->
      <div id="photoPreviewContainer" style="display:none;" class="photo-preview-container">
        <img id="photoPreview" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
        <button class="photo-remove-btn" id="removePhotoBtn">√ó</button>
      </div>

      <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –≤–∏–¥–µ–æ -->
      <div id="videoHint" style="display:none;" class="video-hint">
        üé¨ –í–∏–¥–µ–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
      </div>

      <button id="postButton">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </section>

    <section id="feed">
      <p id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</p>
    </section>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    // üîë –í–∞—à –∫–æ–Ω—Ñ–∏–≥ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA4s_CNAGnOZ5SRjVrdmV1YwX2ZdCPS0NM",
      authDomain: "rednote-ff51d.firebaseapp.com",
      projectId: "rednote-ff51d",
      storageBucket: "rednote-ff51d.firebasestorage.app",
      messagingSenderId: "816401681398",
      appId: "1:816401681398:web:0540d6b83ca2d0ebd115d7",
      measurementId: "G-VFQLG7YF77"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const avatars = [
      "https://api.dicebear.com/7.x/bottts/svg?seed=1",
      "https://api.dicebear.com/7.x/bottts/svg?seed=2",
      "https://api.dicebear.com/7.x/bottts/svg?seed=3",
      "https://api.dicebear.com/7.x/bottts/svg?seed=4",
      "https://api.dicebear.com/7.x/bottts/svg?seed=5",
      "https://api.dicebear.com/7.x/bottts/svg?seed=6",
      "https://api.dicebear.com/7.x/bottts/svg?seed=7",
      "https://api.dicebear.com/7.x/bottts/svg?seed=8"
    ];

    function getProfile() {
      const data = localStorage.getItem('userProfile');
      return data ? JSON.parse(data) : null;
    }

    function saveProfile(name, avatarUrl) {
      const profile = { name, avatarUrl, timestamp: Date.now() };
      localStorage.setItem('userProfile', JSON.stringify(profile));
      return profile;
    }

    async function uploadFile(file) {
      if (!file) return null;
      const storageRef = storage.ref(`posts/${Date.now()}_${file.name}`);
      await storageRef.put(file);
      return await storageRef.getDownloadURL();
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è
    function openProfileModal(isEditing = false) {
      const modal = document.getElementById('profileModal');
      const title = document.getElementById('modalTitle');
      const subtitle = document.getElementById('modalSubtitle');
      const nameInput = document.getElementById('userNameInput');
      const saveBtn = document.getElementById('saveProfileBtn');
      const grid = document.getElementById('avatarGrid');

      if (isEditing) {
        title.textContent = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è';
        subtitle.textContent = '–ò–∑–º–µ–Ω–∏—Ç–µ –∏–º—è –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä';
      } else {
        title.textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RedNote!';
        subtitle.textContent = '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ üëá';
      }

      const profile = getProfile() || { name: '', avatarUrl: avatars[0] };

      nameInput.value = profile.name;
      grid.innerHTML = avatars.map((url, i) => 
        `<div class="avatar-option ${url === profile.avatarUrl ? 'selected' : ''}" data-url="${url}">
          <img src="${url}" alt="–ê–≤–∞—Ç–∞—Ä ${i+1}">
        </div>`
      ).join('');

      grid.querySelectorAll('.avatar-option').forEach(el => {
        el.onclick = () => {
          grid.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
          el.classList.add('selected');
        };
      });

      saveBtn.onclick = () => {
        const name = nameInput.value.trim() || '–ê–Ω–æ–Ω–∏–º';
        const selected = grid.querySelector('.avatar-option.selected');
        const avatarUrl = selected ? selected.dataset.url : avatars[0];

        const newProfile = saveProfile(name, avatarUrl);
        updateUI(newProfile);

        modal.style.display = 'none';
      };

      modal.style.display = 'flex';
    }

    function updateUI(profile) {
      const userStatus = document.getElementById('userStatus');
      userStatus.innerHTML = `<img src="${profile.avatarUrl}" width="28" height="28" style="border-radius:50%;"> <span>${profile.name}</span>`;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function initApp() {
      const profile = getProfile();
      const userStatus = document.getElementById('userStatus');

      if (!profile) {
        openProfileModal(false);
      } else {
        updateUI(profile);
      }

      // --- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
      document.getElementById('settingsBtn').onclick = () => {
        openProfileModal(true);
      };

      // --- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ ---
      const photoInput = document.getElementById('photoInput');
      const videoInput = document.getElementById('videoInput');
      const photoPreviewContainer = document.getElementById('photoPreviewContainer');
      const photoPreview = document.getElementById('photoPreview');
      const removePhotoBtn = document.getElementById('removePhotoBtn');
      const videoHint = document.getElementById('videoHint');

      let photoFile = null;
      let videoFile = null;

      photoInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          photoFile = file;
          const reader = new FileReader();
          reader.onload = (event) => {
            photoPreview.src = event.target.result;
            photoPreviewContainer.style.display = 'block';
            videoHint.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
      };

      videoInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          videoFile = file;
          videoHint.style.display = 'block';
          photoPreviewContainer.style.display = 'none';
        }
      };

      removePhotoBtn.onclick = () => {
        photoFile = null;
        photoInput.value = '';
        photoPreviewContainer.style.display = 'none';
      };

      // --- –†–∞–±–æ—Ç–∞ —Å –ø–æ—Å—Ç–∞–º–∏ ---
      async function addPost(text) {
        const p = getProfile() || { name: '–ê–Ω–æ–Ω–∏–º', avatarUrl: avatars[0] };

        let photoUrl = null;
        let videoUrl = null;

        if (photoFile) {
          photoUrl = await uploadFile(photoFile);
        }
        if (videoFile) {
          videoUrl = await uploadFile(videoFile);
        }

        await db.collection('posts').add({
          text,
          userId: p.name,
          userAvatar: p.avatarUrl,
          media: {
            photo: photoUrl,
            video: videoUrl
          },
          likes: 0,
          likedBy: [],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        photoFile = null;
        videoFile = null;
        photoInput.value = '';
        videoInput.value = '';
        photoPreviewContainer.style.display = 'none';
        videoHint.style.display = 'none';
      }

      async function toggleLike(postId, liked) {
        const p = getProfile() || { name: 'temp' };
        const postRef = db.collection('posts').doc(postId);
        if (liked) {
          await postRef.update({
            likes: firebase.firestore.FieldValue.increment(1),
            likedBy: firebase.firestore.FieldValue.arrayUnion(p.name)
          });
        } else {
          await postRef.update({
            likes: firebase.firestore.FieldValue.increment(-1),
            likedBy: firebase.firestore.FieldValue.arrayRemove(p.name)
          });
        }
      }

      function renderPosts() {
        const feed = document.getElementById('feed');
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        db.collection('posts')
          .orderBy('timestamp', 'desc')
          .onSnapshot(snapshot => {
            loading.style.display = 'none';
            const posts = [];
            snapshot.forEach(doc => {
              posts.push({ id: doc.id, ...doc.data() });
            });

            feed.innerHTML = posts.map(p => {
              const time = new Date(p.timestamp?.toDate?.() || p.timestamp).toLocaleString('ru-RU', {
                day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
              });

              const prof = getProfile();
              const liked = p.likedBy?.includes(prof?.name);
              const avatar = p.userAvatar || avatars[0];
              const author = p.userId || '–ì–æ—Å—Ç—å';

              let mediaHtml = '';
              if (p.media?.photo) {
                mediaHtml += `<img src="${p.media.photo}" alt="–§–æ—Ç–æ">`;
              }
              if (p.media?.video) {
                mediaHtml += `<video controls><source src="${p.media.video}" type="video/mp4">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.</video>`;
              }

              return `
                <article class="post">
                  <div class="post-header">
                    <img src="${avatar}" class="post-avatar" alt="">
                    <span class="post-author">${author}</span>
                    <span class="post-time">${time}</span>
                  </div>
                  <div class="post-content">${(p.text || '').replace(/\n/g, '<br>')}</div>
                  ${mediaHtml ? `<div class="post-media">${mediaHtml}</div>` : ''}
                  <div class="post-actions">
                    <button class="like-btn ${liked ? 'liked' : ''}" data-id="${p.id}">
                      ‚ù§Ô∏è ${p.likes || 0}
                    </button>
                    <button class="comment-btn">üí¨ 0</button>
                  </div>
                </article>
              `;
            }).join('');

            document.querySelectorAll('.like-btn').forEach(btn => {
              btn.onclick = async () => {
                const id = btn.dataset.id;
                const liked = btn.classList.contains('liked');
                await toggleLike(id, !liked);
              };
            });
          });
      }

      document.getElementById('postButton').onclick = async () => {
        const input = document.getElementById('postInput');
        const text = input.value.trim();
        if (!text && !photoFile && !videoFile) return;
        await addPost(text);
        input.value = '';
      };

      document.getElementById('postInput').onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          document.getElementById('postButton').click();
        }
      };

      renderPosts();
    }

    initApp();
  </script>

</body>
</html>
